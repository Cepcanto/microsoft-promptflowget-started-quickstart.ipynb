name: test_actions
on:
  pull_request:
    branches: [ main ]
  workflow_dispatch:
env:
  PYTHONPATH: "${{ github.workspace }}/src/promptflow"
  RUNTIME-CI-RESOURCE-GROUP: promptflow
  RUNTIME-CI-SUBSCRIPTION: ${{ secrets.TEST_WORKSPACE_SUB_ID }}
  RUNTIME-CI-WORKSPACE: ${{ secrets.TEST_WORKSPACE_NAME }}
  aoai-api-endpoint: ${{ secrets.AOAI_API_ENDPOINT_TEST }}
  coverageThreshold: 75
  deployPath: "${{ github.workspace }}/deploy"
  promptflowRepoLocation: "${{ github.workspace }}"
  scriptPath: "${{ github.workspace }}/scripts"
  srcPath: "${{ github.workspace }}/src"
  subscriptionId: ${{ secrets.TEST_WORKSPACE_SUB_ID }}
  testPath: "${{ github.workspace }}/src/promptflow-sdk/tests/promptflow_test"
jobs:
  run_feature_tests:
    name: Geneate Model
    runs-on: ubuntu-latest
    steps:
    - name: checkout
      uses: actions/checkout@v3
    - name: Display Env
      uses: "./.github/actions/pipelines_templates_steps_template_display_environment_variables_step"
    - name: Conda Setup
      uses: "./.github/actions/pipelines_templates_steps_template_create_conda_environment_step"
    - name: Delete existing packages in the 'dist' folder
      working-directory: src/promptflow/
      shell: bash
      run: |
        echo "Delete existing packages in the 'dist' directory of 'promptflow/'"
        rm -f ./dist/*
        if [ $? != 0 ]; then
            echo "Failed to delete existing dist folder for 'promptflow/'"
            exit 1
        fi
    - name: Build wheel
      working-directory: src/promptflow/
      shell: bash -l {0}
      run: |
        conda activate release-env
        echo "Build wheel for 'promptflow/'"
        pip install -r dev_requirements.txt
        python ./setup.py bdist_wheel
        echo "List files in 'dist'"
        ls dist
        pip install './dist/promptflow-0.0.1-py3-none-any.whl[azure]'
    - name: Generate Configs
      uses: "./.github/actions/pipelines_templates_steps_template_generate_configs"
      with:
        tenantId: ${{ secrets.TENANT_ID }}
        clientId: ${{ secrets.CLIENT_ID }}
        clientSecret: ${{ secrets.CLIENT_SECRET }}
        targetFolder: src/promptflow
    - name: Azure Login
      uses: azure/login@v1
      with:
        creds: ${{ secrets.AZURE_CREDENTIALS }}
    - name: Run Coverage Test
      run: |-
        set -x -e
        export IS_IN_CI_PIPELINE="true"
        az account show
        conda activate release-env
        python "../../scripts/building/run_coverage_tests.py" \
          -p promptflow \
          -t "${{ github.workspace }}/src/promptflow/tests/sdk_cli_azure_test" \
          -l eastus \
          -m unittest \
          -n 2
      shell: bash -l {0}
      working-directory: "src/promptflow"
    - name: Upload pytest test results
      uses: actions/upload-artifact@v3
      with:
        name: pytest-results
        path: src/promptflow/test-results.xml
      # Use always() to always run this step to publish test results when there are test failures
      if: ${{ always() }}
    - name: Publish Test Results
      uses: EnricoMi/publish-unit-test-result-action/composite@v2
      if: always()
      with:
        files: |
          src/promptflow/test-results.xml
  

