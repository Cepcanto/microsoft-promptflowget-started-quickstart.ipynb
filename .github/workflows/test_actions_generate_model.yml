name: test_actions
on:
  pull_request:
    branches: [ main ]
  workflow_dispatch:
env:
  PYTHONPATH: "${{ github.workspace }}/src/promptflow"
  RUNTIME-CI-RESOURCE-GROUP: promptflow
  RUNTIME-CI-SUBSCRIPTION: ${{ secrets.TEST_WORKSPACE_SUB_ID }}
  RUNTIME-CI-WORKSPACE: ${{ secrets.TEST_WORKSPACE_NAME }}
  aoai-api-endpoint: ${{ secrets.AOAI_API_ENDPOINT_TEST }}
  coverageThreshold: 75
  deployPath: "${{ github.workspace }}/deploy"
  promptflowRepoLocation: "${{ github.workspace }}"
  scriptPath: "${{ github.workspace }}/scripts"
  srcPath: "${{ github.workspace }}/src"
  subscriptionId: ${{ secrets.TEST_WORKSPACE_SUB_ID }}
  testPath: "${{ github.workspace }}/src/promptflow-sdk/tests/promptflow_test"
jobs:
  run_feature_tests:
    name: Geneate Model
    runs-on: ubuntu-latest
    steps:
    - name: checkout
      uses: actions/checkout@v3
    - name: Display Env
      uses: "./.github/actions/pipelines_templates_steps_template_display_environment_variables_step"
    - name: Conda Setup
      uses: "./.github/actions/pipelines_templates_steps_template_create_conda_environment_step"
    - name: Set up conda environment
      uses: conda-incubator/setup-miniconda@v2
      with:
        miniconda-version: "latest"
        activate-environment: release-env
        environment-file: scripts/building/release-env.yml
        auto-update-conda: true
        auto-activate-base: false
    - name: Show conda info
      shell: bash -l {0}
      run: |
        conda activate release-env
        conda info
        conda list
        conda config --show-sources
        conda config --show
        python --version
    - name: Delete existing packages in the 'dist' folder
      working-directory: src/promptflow/
      shell: bash
      run: |
        echo "Delete existing packages in the 'dist' directory of 'promptflow/'"
        rm -f ./dist/*
        if [ $? != 0 ]; then
            echo "Failed to delete existing dist folder for 'promptflow/'"
            exit 1
        fi
    - name: Build wheel
      working-directory: src/promptflow/
      shell: bash -l {0}
      run: |
        conda activate release-env
        echo "Build wheel for 'promptflow/'"
        python setup.py bdist_wheel -b bdist
        echo "List files in 'dist'"
        cd dist
        pwd
        ls
    - uses: "./.github/actions/pipelines_templates_steps_template_generate_configs"
      with:
        tenantId: ${{ secrets.TENANT_ID }}
        clientId: ${{ secrets.CLIENT_ID }}
        clientSecret: ${{ secrets.CLIENT_SECRET }}
        targetFolder: ${{ env.PYTHONPATH }}

