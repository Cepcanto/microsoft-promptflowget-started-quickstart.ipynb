$schema: https://azuremlschemas.azureedge.net/promptflow/latest/OrchestrationRun.schema.json

flows:
  data_gen:
    flow: ../data/generate_data.yaml
    column_mapping:
      seed: xxx.pdf
  main:
    flow: flow_directory
    column_mapping:
      question: ${data_gen.outputs.question}
  eval_flow1:
    flow: ../evaluation/similarity.yaml
    column_mapping:
      temperature: 0.5
      ground_truth: ${data_gen.outputs.ground_truth}
      prediction: ${main.outputs.chat_output}
  eval_flow2:
    flow: ../evaluation/asserts.yaml
    column_mapping: # inputs
      asserts: ${data_gen.outputs.asserts}
      answer: ${main.outputs.chat_output}
    connections:
      node1.connection: open_ai_connection  # Override flow node connection

aggregations:
  avg_similarity:
    op: AVG
    input: ${eval_flow1.outputs.score}
  p95_similarity:
    op: p95
    input: ${eval_flow1.outputs.score}
  avg_asserts:
    source:
      type: code
      path: pass_rate.py
    inputs:
      results: ${eval_flow2.outputs}  # Aggregated list of flow output lines
